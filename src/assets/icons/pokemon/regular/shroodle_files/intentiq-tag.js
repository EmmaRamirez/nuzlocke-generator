"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _createForOfIteratorHelper(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,e=function(){};return{s:e,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){s=!0,r=t},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw r}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function IntentIqObject(t){if(this.agentId=Date.now()+"_"+this.getRandom(0,1e3),window&&(window.iiq_object_array=window.iiq_object_array||[],window.iiq_object_array.push(this)),this.partnerData={},this.version=5.31,this.intentIqData={},this.isCellular=!1,this.wasDebugCheck=!1,this.wasServerCalled=!1,this.wasCallFromConstructor=!1,this.wasCallbackFired=!1,this.callCount=0,this.manualCallCount=0,this.pubprovidedPrebidCallCount=0,this.noDataCounter=0,this.failCount=0,this.metadataConstant=256,this.syncRefreshMillis=36e5,this.shouldCallServer=!1,this.isPrebidConfigurationSet=!1,this.userProvidedConfig=t,this.lastDataUpdateDate=0,this.configurationTime=0,this.requestRtt=0,this.allBidsMap={},this.messagesArray=[],this.partnerAuctionIdsArray=[],this.reportingServerAddress="https://reports.intentiq.com",this.gatewayServerAddress="https://ucgfk6g6s7.execute-api.us-east-1.amazonaws.com",this.dataReportingPath="report",this.delayedSenderTimeouter=null,this.gatewayWasCalled=!1,this.localStorageEnabled=void 0,this.pubprovidedidsFailedToregister=!1,this.calltype={internal:"i",pubprovided:"p"},this.callbackTimeotID=null,this.eidsReceptionsTime=null,this.eidsNames=[],this.useLodalData=!1,this.auctionStartTimeData={},this.auctionEidsLength={},this.dataSentOnUnload=!1,this.hadEidsInLocalStorage,this.logger=this.initLogger(),this.isDebugMode=this.isDebug()||!1,this.currentBrowserLowerCase=this.detectBrowser().toLowerCase(),this.cookiFullBrowsersListLowercase=["chrome"],this.intentIqConfig={partner:t?t.partner:null,refreshInMillis:t&&"number"==typeof t.refreshInMillis?t.refreshInMillis:432e5,timeoutInMillis:t&&"number"==typeof t.timeoutInMillis?t.timeoutInMillis:3e3,isAsyncServerRequest:!t||"boolean"!=typeof t.isAsyncServerRequest||t.isAsyncServerRequest,callback:t&&"function"==typeof t.callback?t.callback:null,enhanceRequests:!t||"boolean"!=typeof t.enhanceRequests||t.enhanceRequests,sourceMetaData:t&&"string"==typeof t.sourceMetaData?this.translateMetadata(t.sourceMetaData):this.translateMetadata(""),iiqServerAddress:t&&"string"==typeof t.iiqServerAddress?t.iiqServerAddress:"https://api.intentiq.com",iiqPixelServerAddress:t&&"string"==typeof t.iiqPixelServerAddress?t.iiqPixelServerAddress:"https://sync.intentiq.com",partnerClientId:t&&"string"==typeof t.partnerClientId?t.partnerClientId:"",partnerClientIdType:t&&"number"==typeof t.partnerClientIdType?this.verifyIdType(t.partnerClientIdType):-1,pbjs:t&&void 0!==t.pbjs?t.pbjs:null,shouldRepalcePubprovided:!t||"boolean"!=typeof t.shouldRepalcePubprovided||t.shouldRepalcePubprovided,shouldSetUidsModulesConfig:!t||"boolean"!=typeof t.shouldSetUidsModulesConfig||t.shouldSetUidsModulesConfig,shouldClearDuplicatresForRubicon:!(!t||"boolean"!=typeof t.shouldClearDuplicatresForRubicon)&&t.shouldClearDuplicatresForRubicon,manualWinReportEnabled:!(!t||"boolean"!=typeof t.manualWinReportEnabled)&&t.manualWinReportEnabled,messageSendingDelay:t&&!isNaN(t.reportDelay)?t.reportDelay:0,domainName:t&&t.domainName?t.domainName:"",shouldReplaceUnifiedId:t&&"boolean"==typeof t.shouldReplaceUnifiedId?t.shouldReplaceUnifiedId:this.unifiedIdReplacementLogic(),browserBlackList:t&&"string"==typeof t.browserBlackList?t.browserBlackList.toLowerCase():"",shouldFilerTdidFromPPuid:!t||"boolean"!=typeof t.shouldFilerTdidFromPPuid||t.shouldFilerTdidFromPPuid,reportMethod:t&&"string"==typeof t.reportMethod?this.parseReportingMethod(t.reportMethod):"GET",appendEidsNamesToReport:!(!t||"boolean"!=typeof t.appendEidsNamesToReport)&&t.appendEidsNamesToReport},""!==this.intentIqConfig.browserBlackList&&this.intentIqConfig.browserBlackList.includes(this.currentBrowserLowerCase))return this.logger.info("Browser is in blacklist. Good buy."),void(this.intentIqConfig.callback&&this.intentIqConfig.callback());this.intentIqConfig.lsKeys={FIRST_PARTY_KEY:"_iiq_fdata",PARTNER_DATA_KEY:"_iiq_fdata_"+this.intentIqConfig.partner,LAST_SYNC_KEY:"_iiq_sync_"+this.intentIqConfig.partner,abGroup:"_iiq_ab_group_"+this.intentIqConfig.partner,abPercentage:"_iiq_ab_percentage_"+this.intentIqConfig.partner,pbMonitoringEnabled:"_iiq_pb_monitoringenabled_"+this.intentIqConfig.partner,pbPauseUntill:"_iiq_pb_pausetill_"+this.intentIqConfig.partner,requestRtt:"_iiq_requestrtt_"+this.intentIqConfig.partner,DEBUG_KEY:"_iiq_debug_level"},this.checkAndPrintPrebidInitAuctions("Before object init"),this.configurationTime=Date.now(),this.intentIqConfig.moduleIds={unifiedeId:null},this.intentIqConfig.operationalMode={vr:"VR",pixel:"PIXEL",dual:"DUAL",node:"NONE",current:t&&"string"==typeof t.mode?this.getOperationalMode(t.mode):"DUAL"},t&&t.intentIqData&&"undefined"!==t.intentIqData&&(this.intentIqData=t.intentIqData,this.intentIqConfig.operationalMode.current=this.intentIqConfig.operationalMode.vr,this.useLodalData=!0,this.intentIqConfig.pbmonitoring=!0),this.intentIqConfig.collisionPreventionMode={pub:"PUB",other:"OTHER",none:"NONE",current:t&&"string"==typeof t.idCollisionPreventionMode?this.parseCollisionPreventionMode(t.idCollisionPreventionMode):"NONE"},this.intentIqConfig.serverResponse={abPercentage:"abPercentage",abTestGroup:"abGroup",pbPauseUntill:"pbPauseUntil",pbMonitoringEnabled:"pbMonitoringEnabled",isInTestGroup:"isInTestGroup",enhanceRequests:"enhanceRequests",wasSubscribedForPrebid:"wasSubscribedForPrebid",hadEids:"hadEids",userActualPercentage:"userPercentage",ABTestingConfigurationSource:"ABTestingConfigurationSource",lateConfiguration:"lateConfiguration",jsverion:"jsversion",eidsNames:"eidsNames",requestRtt:"rtt",clientType:"clientType",adserverDeviceType:"AdserverDeviceType",terminationCause:"terminationCause",callCount:"callCount",manualCallCount:"mcc",pubprovidedidsFailedToregister:"ppcc",noDataCount:"noDataCount",profile:"profile",isProfileDeterministic:"pidDeterministic",siteId:"sid",hadEidsInLocalStorage:"idls",auctionStartTime:"ast",eidsReadTime:"eidt",agentId:"aid",auctionEidsLegth:"aeidln",wasServerCalled:"wsrvcll",refferer:"vrref"},this.intentIqConfig.urlParamsNames={isInTestGroup:"abtgu",testPercentage:"abtp",testPreviousPercentage:"abtpp",testGroup:"abtg",pbPauseUntill:"pbpause",requestRtt:"rrtt",lastDataUpdateDate:"dud"},this.intentIqConfig.analytics={requestRtt:0,clientType:"",adserverDeviceType:"",terminationCause:"",profile:"",siteId:null},this.intentIqConfig.abTesting={groupNames:{withoutIIQ:"B",withIIQ:"A",notYetDefined:"U",none:"N"},configurationSource:{percentage:"percentage",group:"group",iiqserver:"IIQServer",disabled:"disabled",currentConfigurationSource:this.parseConfigurationSource(t.ABTestingConfigurationSource)},currentPercentage:-1,isInTestGroup:t.disableIIQInThisGroup,previousPercentage:-1,currentTestGroup:"U",previousTestGroup:"U",shouldDiscardServerConfiguration:!1,userActualPercentage:t.abPercentage},this.intentIqConfig.pbmonitoring={pbMonitoringEnabled:!t||"boolean"!=typeof t.pbMonitoringEnabled||!0===t.pbMonitoringEnabled,pbPauseUntill:-1},this.intentIqConfig.subscriptionFlags={bidWon:!1,bidRequested:!1,beforeBidderHttp:!1,auctionInited:!1},this.intentIqConfig.isInPassiveMode=!1,this.intentIqConfig.metadatResolutionEnabled=!1,this.currentDataTTl=this.intentIqConfig.refreshInMillis,this.firstPartyData=this.loadOrCreateFirstPartyData(),this.initPbMonitoring(),this.subscribeForPrebidEvents(),this.initABTestingConfiguration(),this.clearDataIfInGroupBorPassiveMode(),this.getIntentIqData(),this.intentIqConfig.operationalMode.current!==this.intentIqConfig.operationalMode.vr&&this.pixelSync();var t=function(t,e){return"pbjs"==t||"lsKeys"==t||"serverResponse"==t||"urlParamsNames"==t||"groupNames"==t?"skipped in printing":e},e=this;if(0===this.intentIqConfig.messageSendingDelay)this.logger.info("Skipping registering on unload events, message delay = 0");else{this.logger.info("Initializing on unload events");try{window.onbeforeunload=function(){e.dataSentOnUnload=!0,0<e.messagesArray.length&&e.dataSender(e)}}catch(t){this.logger.error("Failed to susbscibe for onbeforeunload")}try{window.onunload=function(){!1===e.dataSentOnUnload&&0<e.messagesArray.length&&e.dataSender(e)}}catch(t){this.logger.error("Failed to susbscibe for onbeforeunload")}}this.logger.info("========IIQ Agent version "+this.version+"========"),this.logger.info("--------User configuration---------"),this.logger.debug(JSON.stringify(this.userProvidedConfig,t,2)),this.logger.info("--------Startup configuration---------"),this.logger.debug(JSON.stringify(this.intentIqConfig,t,2)),this.logger.info("--------------------------------------"),this.callbackTimeotID||(this.logger.info("Configuring failsafe callback"),this.callbackTimeotID=setTimeout(this.fireCallbackOnRequestTimeout.bind(null,this),this.intentIqConfig.timeoutInMillis))}function PartnersWinEvent(t){this.constants={noteReported:"NR"},this.biddingPlatformId=t&&t.biddingPlatformId&&!isNaN(t.biddingPlatformId)?t.biddingPlatformId:1,this.partnerAuctionId=t&&t.partnerAuctionId?t.partnerAuctionId:this.constants.noteReported,this.bidderCode=t&&t.bidderCode?t.bidderCode:this.constants.noteReported,this.prebidAuctionId=t&&t.prebidAuctionId?t.prebidAuctionId:this.constants.noteReported,this.cpm=t&&t.cpm&&!isNaN(t.cpm)?t.cpm:-1,this.currency=t&&t.currency?t.currency:this.constants.noteReported,this.originalCpm=t&&t.originalCpm&&!isNaN(t.originalCpm)?t.originalCpm:this.cpm,this.originalCurrency=t&&t.originalCurrency?t.originalCurrency:this.currency,this.status=t&&t.status?t.status:this.constants.noteReported,this.placementId=t&&t.placementId?t.placementId:this.constants.noteReported}IntentIqObject.prototype.unifiedIdReplacementLogic=function(){return this.currentBrowserLowerCase||(this.currentBrowserLowerCase=this.detectBrowser().toLowerCase()),this.cookiFullBrowsersListLowercase.includes(this.currentBrowserLowerCase)?(this.logger.info("CookieFull browser detected, setting unifyed id override logic to: FALSE"),!1):(this.logger.info("Cookieless browser detected, setting unifyed id override logic to: TRUE"),!0)},IntentIqObject.prototype.clearDataIfInGroupBorPassiveMode=function(){var t;this.intentIqConfig.isInPassiveMode||this.intentIqConfig.abTesting.currentTestGroup===this.intentIqConfig.abTesting.groupNames.withoutIIQ?(null!=(t=this.readData(this.intentIqConfig.lsKeys.PARTNER_DATA_KEY))&&((t=JSON.parse(t)).data={},this.storeData(this.intentIqConfig.lsKeys.PARTNER_DATA_KEY,JSON.stringify(t))),this.logger.info("Calling callback - passive mode or group B set"),this.fireCallback()):this.callbackTimeotID||(this.callbackTimeotID=setTimeout(this.fireCallbackOnRequestTimeout.bind(null,this),this.intentIqConfig.timeoutInMillis))},IntentIqObject.prototype.parseReportingMethod=function(t){try{switch(t.toUpperCase()){case"GET":return"GET";case"POST":return"POST";default:return"GET"}}catch(t){this.logger.error(t)}return"GET"},IntentIqObject.prototype.fireCallbackOnRequestTimeout=function(t){t.logger.info("Trying to fire callback on timeout"),t.fireCallback()},IntentIqObject.prototype.checkAndPrintPrebidInitAuctions=function(t){try{if(!this.isDebug())return;if(this.logger.info("Validation at stage: "+t),!this.intentIqConfig.pbjs)return void this.logger.error("Pbjs wasn't defined");if(!this.intentIqConfig.pbjs.getEvent)return void this.logger.info("Pbjs was defined but it has no getEvents method. Right on time.");this.logger.info("Total amount of events is "+this.intentIqConfig.pbjs.getEvent()),this.logger.info("Amount of auctionInit events is "+this.intentIqConfig.pbjs.getEvents().filter(function(t){return"auctionInit"===t.eventType}).length)}catch(t){this.logger.error("Failed to report pbjs events state")}},IntentIqObject.prototype.extractIdentittyModulesIds=function(){try{if(this.intentIqData&&this.intentIqData.eids&&Array.isArray(this.intentIqData.eids)){var t,e=_createForOfIteratorHelper(this.intentIqData.eids);try{for(e.s();!(t=e.n()).done;){var n=t.value;if(n.source&&"adserver.org"===n.source&&n.uids[0].id){this.intentIqConfig.moduleIds.unifiedeId=n.uids[0].id;break}}}catch(t){e.e(t)}finally{e.f()}}}catch(t){}},IntentIqObject.prototype.fillEidsNames=function(){try{if(!this.intentIqConfig.appendEidsNamesToReport)return void this.logger.info("Skipping eids names population due to configuration");if(this.eidsNames=[],this.intentIqData&&this.intentIqData.eids&&Array.isArray(this.intentIqData.eids)){var t,e=_createForOfIteratorHelper(this.intentIqData.eids);try{for(e.s();!(t=e.n()).done;){var n=t.value;this.eidsNames.push(n.source)}}catch(t){e.e(t)}finally{e.f()}}}catch(t){this.logger.fatal("Failed to collect eids names")}},IntentIqObject.prototype.initPbMonitoring=function(){!0!==this.intentIqConfig.manualWinReportEnabled?this.userProvidedConfig&&"boolean"==typeof this.userProvidedConfig.pbMonitoringEnabled&&(this.intentIqConfig.pbmonitoring.pbMonitoringEnabled=!0===this.userProvidedConfig.pbMonitoringEnabled):this.intentIqConfig.pbmonitoring.pbMonitoringEnabled=!1},IntentIqObject.prototype.loadOrCreateFirstPartyData=function(){var t=this.tryParse(this.readData(this.intentIqConfig.lsKeys.FIRST_PARTY_KEY));return t&&t.pid&&(this.intentIqConfig.analytics.profile=t.pid),t&&t.pcid?t&&!t.pcidDate&&(t.pcidDate=Date.now()):t={pcid:this.generateGUID(),pcidDate:Date.now()},this.storeData(this.intentIqConfig.lsKeys.FIRST_PARTY_KEY,JSON.stringify(t)),t},IntentIqObject.prototype.parseConfigurationSource=function(t){return"percentage"===t||"group"===t||"IIQServer"===t||"disabled"===t?t:"disabled"},IntentIqObject.prototype.getOperationalMode=function(t){try{switch(t.toLowerCase()){case"bidenhancement":return"VR";case"sync":return"PIXEL";case"both":return"DUAL"}}catch(t){this.logger.error(t)}return this.intentIqConfig.operationalMode.dual},IntentIqObject.prototype.verifyIdType=function(t){return 0===t||1===t||3===t||4===t?t:-1},IntentIqObject.prototype.parseCollisionPreventionMode=function(t){try{switch(t.toLowerCase()){case"pub":return"PUB";case"other":return"OTHER";case"none":return"NONE"}}catch(t){this.logger.error(t)}return this.intentIqConfig.collisionPreventionMode.none},IntentIqObject.prototype.detectBrowser=function(){try{return-1!=(navigator.userAgent.indexOf("Opera")||navigator.userAgent.indexOf("OPR"))?"Opera":-1!=navigator.userAgent.indexOf("Chrome")?"Chrome":-1!=navigator.userAgent.indexOf("Safari")?"Safari":-1!=navigator.userAgent.indexOf("Firefox")?"Firefox":-1!=navigator.userAgent.indexOf("MSIE")||1==!!document.documentMode?"IE":"Unknown"}catch(t){return"Unknown"}},IntentIqObject.prototype.translateMetadata=function(t){try{var e=t.split(".");return((+e[0]*this.metadataConstant+ +e[1])*this.metadataConstant+ +e[2])*this.metadataConstant+ +e[3]}catch(t){return NaN}},IntentIqObject.prototype.getRandom=function(t,e){return Math.floor(Math.random()*(e-t+1)+t)},IntentIqObject.prototype.generateRandom1to99=function(){return Math.floor(99*Math.random())+1},IntentIqObject.prototype.isEmpty=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},IntentIqObject.prototype.isEmptyObjAndArray=function(t){return!t||"object"==_typeof(t)&&this.isEmpty(t)},IntentIqObject.prototype.isDefined=function(t){return void 0!==t&&null!=t},IntentIqObject.prototype.containsEids=function(t){var e=!1;try{e="data"in t&&"eids"in t.data&&Array.isArray(t.data.eids)&&0<t.data.eids.length}catch(t){}return e},IntentIqObject.prototype.generateRandomUsIp=function(){var t=this.readData("_iiq_ip");return(!t||this.isIpCellular(t)&&!this.isCellular||!this.isIpCellular(t)&&this.isCellular)&&(t=this.generateNewRandomIp(this.isCellular),this.storeData("_iiq_ip",t)),t},IntentIqObject.prototype.isIpCellular=function(t){return t.startsWith("107.77.208.")},IntentIqObject.prototype.generateNewRandomIp=function(t){t=t?"107.77.208.":"98.115.221.";return t+=Math.floor(255*Math.random())},IntentIqObject.prototype.tryParse=function(t){try{return JSON.parse(t)}catch(t){this.logger.error(t)}return null},IntentIqObject.prototype.tryParseInt=function(t){try{return parseInt(t,10)}catch(t){return this.logger.error(t),-1}},IntentIqObject.prototype.addLevelValue=function(t){if("string"==typeof t&&this.logger.allLevels[t=t.toUpperCase()])return t.toUpperCase();return"FATAL"},IntentIqObject.prototype.initLogger=function(){var o=this;return{info:function(t){this.log("INFO",t)},debug:function(t){this.log("DEBUG",t)},fatal:function(t){this.log("FATAL",t)},error:function(t){this.log("ERROR",t)},trace:function(t){this.log("TRACE",t)},log:function(t,e){this.isLessThanOrEqualTo(t)&&this._print(e,t)},isLessThanOrEqualTo:function(t){return this.allLevels[o.levelValue].value>=this.allLevels[t].value},_print:function(t,e){var n=this.allLevels[e].colour,i=this.allLevels[e].secondary_color,r=o&&o.intentIqConfig&&o.intentIqConfig.partner?o.intentIqConfig.partner:o.userProvidedConfig?o.userProvidedConfig.partner:null;console.log("".concat(r," %c[").concat(e,"]%c [").concat(Date.now(),"] %c").concat(t),"color: white ; background-color:"+n+"; border-radius: 3px","border:none","color: "+i+" ; border:1px solid "+n+"; border-radius: 3px")},allLevels:{FATAL:{value:10,colour:"magenta",secondary_color:"magenta"},INFO:{value:20,colour:"green",secondary_color:"green"},ERROR:{value:30,colour:"red",secondary_color:"red"},DEBUG:{value:40,colour:"cyan",secondary_color:"grey"},TRACE:{value:50,colour:"blue",secondary_color:"blue"}}}},IntentIqObject.prototype.isDebug=function(){var t;return this.wasDebugCheck||(this.levelValue="FATAL",!this.hasLocalStorage()||null!==(t=this.readData("_iiq_debug_level"))&&(this.isDebugMode=!0,this.levelValue=this.addLevelValue(t)),this.wasDebugCheck=!0),this.isDebugMode},IntentIqObject.prototype.setInfoLevel=function(){this.storeData("_iiq_debug_level","INFO")},IntentIqObject.prototype.setDebugLevel=function(){this.storeData("_iiq_debug_level","DEBUG")},IntentIqObject.prototype.setTraceLevel=function(){this.storeData("_iiq_debug_level","TRACE")},IntentIqObject.prototype.hasLocalStorage=function(){if(void 0!==this.localStorageEnabled)return this.localStorageEnabled;try{return this.localStorageEnabled=!!window.localStorage,this.localStorageEnabled}catch(t){this.localStorageEnabled=!1,this.logger.info("Local storage api disabled")}return!1},IntentIqObject.prototype.storeData=function(t,e){try{"string"==typeof t&&t.startsWith("iiq_fdata")&&this.logger.info("IntentIQ: storing data: key="+t+" value="+e),this.isDefined(e)&&this.hasLocalStorage()&&window.localStorage.setItem(t,e)}catch(t){this.logger.error(t)}},IntentIqObject.prototype.readData=function(t){try{if(this.hasLocalStorage())return window.localStorage.getItem(t)}catch(t){this.logger.error(t)}return null},IntentIqObject.prototype.generateGUID=function(){var n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"===t?e:3&e|8).toString(16)})},IntentIqObject.prototype.clearCounters=function(){this.callCount=0,this.failCount=0,this.noDataCounter=0,this.manualCallCount=0,this.pubprovidedPrebidCallCount=0,this.savePartnerDataToLocalStore()},IntentIqObject.prototype.fireCallback=function(){try{var t;null===this.intentIqConfig.callback||void 0===this.intentIqConfig.callback||this.wasCallbackFired?this.logger.info("Skippping calback fire , already fired or not defined"):(t=this.wasCallbackFired,this.wasCallbackFired=!0,null!==this.callbackTimeotID&&(this.logger.info("Removing callback timeout - got it first"),clearTimeout(this.callbackTimeotID)),this.logger.info("Actual callback fire."),this.intentIqConfig.callback(this.intentIqData,!t))}catch(t){}},IntentIqObject.prototype.getInternalIntentIqEids=function(e){void 0===e&&(e=this);try{return e.getIntentIqEids(e,e.calltype.internal)}catch(t){e.failCount++,e.logger.error("Failed to get EIDS for internal call"),e.savePartnerDataToLocalStore()}return[]},IntentIqObject.prototype.getPubprovidedEids=function(e){void 0===e&&(e=this);try{var t=JSON.parse(JSON.stringify(e.getIntentIqEids(e,e.calltype.pubprovided)));if(0==e.intentIqConfig.shouldFilerTdidFromPPuid)return t;for(var n=0;n<t.length;n++)if(t[n].source&&"adserver.org"===t[n].source&&t[n].uids[0].id){t.splice(n,1);break}return t}catch(t){e.failCount++,e.logger.error("Failed to get EIDS for internal call"),e.savePartnerDataToLocalStore()}return[]},IntentIqObject.prototype.getIntentIqEids=function(e,t){void 0===e&&(e=this);try{if(e.intentIqConfig.isInPassiveMode||e.intentIqConfig.operationalMode.current===e.intentIqConfig.operationalMode.pixel)return[];if(e.intentIqConfig.abTesting.currentTestGroup===e.intentIqConfig.abTesting.groupNames.withoutIIQ)return[];var n=e.getIntentIqData(t);if(n&&n.eids)return n.eids}catch(t){e.failCount++,e.logger.error("Parse response eids got exception"),e.savePartnerDataToLocalStore()}return[]},IntentIqObject.prototype.loadPartnerData=function(){var t=this.tryParse(this.readData(this.intentIqConfig.lsKeys.PARTNER_DATA_KEY));return t?(this.hadEidsInLocalStorage=!1,(t.data||this.useLodalData)&&(!this.intentIqConfig.isInPassiveMode&&this.intentIqConfig.abTesting.currentTestGroup!==this.intentIqConfig.abTesting.groupNames.withoutIIQ||(t.data={}),!1===this.useLodalData?this.intentIqData=t.data:t.data=this.intentIqData,this.intentIqData&&this.intentIqData.eids&&Array.isArray(this.intentIqData.eids)&&(this.hadEidsInLocalStorage=0<this.intentIqData.eids.length),this.extractIdentittyModulesIds(),this.fillEidsNames(),this.eidsReceptionsTime=Date.now()),"number"==typeof t.callCount&&(this.callCount=t.callCount),"number"==typeof t.manualCallCount&&(this.manualCallCount=t.manualCallCount),"number"==typeof t.pubprovidedPrebidCallCount&&(this.pubprovidedPrebidCallCount=t.pubprovidedPrebidCallCount),"number"==typeof t.failCount&&(this.failCount=t.failCount),"number"==typeof t.noDataCounter&&(this.noDataCounter=t.noDataCounter),"number"==typeof t.cttl&&(this.currentDataTTl=t.cttl,this.logger.info("Custom data TTL loaded from LS, value: "+this.currentDataTTl)),t.date&&(this.lastDataUpdateDate=t.date,this.shouldCallServer=Date.now()-t.date>this.currentDataTTl),t.ct&&(this.intentIqConfig.analytics.clientType=t.clientType),t.adserverDeviceType&&(this.intentIqConfig.analytics.adserverDeviceType=t.adserverDeviceType),t.terminationCause&&(this.intentIqConfig.analytics.terminationCause=t.terminationCause),t.pidDeterministic&&(this.intentIqConfig.analytics.pidDeterministic=t.pidDeterministic),t.siteId&&(this.intentIqConfig.analytics.siteId=t.siteId)):(t={},this.shouldCallServer=!0),t},IntentIqObject.prototype.getIntentIqData=function(t){try{if(this.intentIqConfig.operationalMode.current===this.intentIqConfig.operationalMode.pixel)return{};if("number"!=typeof this.intentIqConfig.partner)return this.failCount++,this.logger.error("intentIqId requires a valid partner to be defined"),{};var e;this.partnerData=this.loadPartnerData(),this.wasCallFromConstructor?(void 0!==t?t===this.calltype.internal||t===this.calltype.pubprovided&&this.pubprovidedPrebidCallCount++:(this.manualCallCount++,this.containsEids(this.partnerData)||(this.noDataCounter=this.noDataCounter+1)),this.savePartnerDataToLocalStore()):this.wasCallFromConstructor=!0,this.shouldCallServer&&!this.wasServerCalled&&!1===this.useLodalData?(this.wasServerCalled=!0,e=this.createRequestUrl(!1),this.makeServerRequest(e,!0)):(this.savePartnerDataToLocalStore(),this.isPrebidConfigurationSet||(this.isPrebidConfigurationSet=!0,this.configurePrebid()));var n,i=!this.isEmptyObjAndArray(this.intentIqData)||!this.shouldCallServer;return this.intentIqConfig.callback&&!this.wasCallbackFired&&i&&(n=this.wasCallbackFired,this.wasCallbackFired=!0,this.logger.info("Actual callback fire."),this.intentIqConfig.callback(this.intentIqData,!n)),this.intentIqData||{}}catch(t){this.failCount++,this.logger.error("Exception occurred during main logic: "+t),this.savePartnerDataToLocalStore()}return{}},IntentIqObject.prototype.createPixelUrl=function(){var t=this.intentIqConfig.iiqPixelServerAddress+"/profiles_engine/ProfilesEngineServlet?at=20&mi=10&secure=1";return t+="&dpi="+this.intentIqConfig.partner,t+="&rnd="+this.getRandom(0,1e6),t=this.appendFirstPartyDataToUrl(t),t=this.addUniquenessToUrl(t),t=this.addMetaData(t),t=this.appendPartnersFirsyParty(t),t=this.appendReferrerToUrl(t),t+=this.version?"&jsver="+encodeURIComponent(this.version):"",this.appendABTestingData(t)},IntentIqObject.prototype.pixelSync=function(){try{var t,e=parseInt(this.readData(this.intentIqConfig.lsKeys.LAST_SYNC_KEY));(!e||Date.now()-e>this.syncRefreshMillis)&&(t=this.createPixelUrl(),this.appendImage(t),this.storeData(this.intentIqConfig.lsKeys.LAST_SYNC_KEY,Date.now()+""))}catch(t){this.logger.error("Error adding pixel to DOM "+t)}},IntentIqObject.prototype.appendImage=function(t){var e;this.isDefined(t)&&((e=document.createElement("img")).src=t,e.width=1,e.height=1,this.isDefined(document.body)?document.body.appendChild(e):window.addEventListener("load",function(){try{document.body.appendChild(e)}catch(t){}}))},IntentIqObject.prototype.tryExtractConfiguration=function(t){this.intentIqConfig.abTesting.shouldDiscardServerConfiguration||(this.logger.info("Extracting AB testing parameter"),this.tryExtractABTestingConfiguration(t)),this.logger.info("Extracting monitoring parameter")},IntentIqObject.prototype.tryExtractABTestingConfiguration=function(t){var e;this.intentIqConfig.serverResponse.abPercentage in t&&(e=this.tryParseInt(t[this.intentIqConfig.serverResponse.abPercentage]),this.logger.info("abPercentage received: "+t[this.intentIqConfig.serverResponse.abPercentage]),e!==this.intentIqConfig.abTesting.currentPercentage&&(this.logger.info("abPercentage has changed from:"+this.intentIqConfig.abTesting.currentPercentage+" to:"+t[this.intentIqConfig.serverResponse.abPercentage]),this.intentIqConfig.abTesting.previousPercentage=this.intentIqConfig.abTesting.currentPercentage,this.intentIqConfig.abTesting.currentPercentage=e,this.generateTestGroupAccordingToPercentageAndConfigure(),this.persistABTestingSettingsToLS()))},IntentIqObject.prototype.configureABTestingForIIQServer=function(){this.intentIqConfig.abTesting.currentTestGroup=this.intentIqConfig.abTesting.groupNames.notYetDefined,this.intentIqConfig.abTesting.previousTestGroup=this.intentIqConfig.abTesting.groupNames.notYetDefined,this.intentIqConfig.abTesting.shouldDiscardServerConfiguration=!1,this.intentIqConfig.isInPassiveMode=!1},IntentIqObject.prototype.configureABTestingForGroupA=function(){this.intentIqConfig.abTesting.currentTestGroup=this.intentIqConfig.abTesting.groupNames.withIIQ,this.intentIqConfig.abTesting.previousTestGroup=this.intentIqConfig.abTesting.groupNames.notYetDefined,this.intentIqConfig.abTesting.currentPercentage=100,this.intentIqConfig.abTesting.shouldDiscardServerConfiguration=!0,this.intentIqConfig.isInPassiveMode=!1},IntentIqObject.prototype.configureABTestingForGroupB=function(){this.intentIqConfig.abTesting.currentTestGroup=this.intentIqConfig.abTesting.groupNames.withoutIIQ,this.intentIqConfig.abTesting.previousTestGroup=this.intentIqConfig.abTesting.groupNames.notYetDefined,this.intentIqConfig.abTesting.currentPercentage=0,this.intentIqConfig.abTesting.shouldDiscardServerConfiguration=!0,this.intentIqConfig.isInPassiveMode=!0},IntentIqObject.prototype.configureABTestingForPercentage=function(){this.intentIqConfig.abTesting.currentTestGroup=this.intentIqConfig.abTesting.groupNames.notYetDefined,this.intentIqConfig.abTesting.previousTestGroup=this.intentIqConfig.abTesting.groupNames.notYetDefined,this.intentIqConfig.abTesting.shouldDiscardServerConfiguration=!0,this.intentIqConfig.isInPassiveMode=!1},IntentIqObject.prototype.configurationSourceGroupInitilization=function(){this.userProvidedConfig&&"boolean"==typeof this.userProvidedConfig.disableIIQInThisGroup?(this.intentIqConfig.abTesting.isInTestGroup=!0===this.userProvidedConfig.disableIIQInThisGroup,!0===this.userProvidedConfig.disableIIQInThisGroup?this.configureABTestingForGroupB():this.configureABTestingForGroupA()):this.configureABTestingForGroupA()},IntentIqObject.prototype.configurationSourcePercentageInitilization=function(){switch(this.userProvidedConfig&&"number"==typeof this.userProvidedConfig.abPercentage&&this.userProvidedConfig.abPercentage<101&&-1<this.userProvidedConfig.abPercentage?this.intentIqConfig.abTesting.userActualPercentage=this.userProvidedConfig.abPercentage:this.intentIqConfig.abTesting.userActualPercentage=-2,this.intentIqConfig.abTesting.userActualPercentage){case 0:this.configureABTestingForGroupB();break;case 100:case-2:this.configureABTestingForGroupA();break;default:this.configureABTestingForPercentage()}},IntentIqObject.prototype.abTestingAdvancedConfiguration=function(){var t;this.intentIqConfig.abTesting.currentTestGroup===this.intentIqConfig.abTesting.groupNames.notYetDefined&&(t=this.readData(this.intentIqConfig.lsKeys.abPercentage),isNaN(parseInt(t))||(this.intentIqConfig.abTesting.currentPercentage=Number(t)),null!=(t=this.readData(this.intentIqConfig.lsKeys.abGroup))&&(this.intentIqConfig.abTesting.currentTestGroup=t,this.intentIqConfig.isInPassiveMode=this.intentIqConfig.abTesting.currentTestGroup===this.intentIqConfig.abTesting.groupNames.withoutIIQ),this.intentIqConfig.abTesting.configurationSource.currentConfigurationSource===this.intentIqConfig.abTesting.configurationSource.percentage&&this.isDefined(this.intentIqConfig.abTesting.userActualPercentage)&&0<this.intentIqConfig.abTesting.userActualPercentage&&this.intentIqConfig.abTesting.userActualPercentage<100&&this.intentIqConfig.abTesting.userActualPercentage!==this.intentIqConfig.abTesting.currentPercentage&&(this.intentIqConfig.abTesting.previousTestGroup=this.intentIqConfig.abTesting.currentTestGroup,this.intentIqConfig.abTesting.previousPercentage=this.intentIqConfig.abTesting.currentPercentage,this.intentIqConfig.abTesting.currentPercentage=this.intentIqConfig.abTesting.userActualPercentage,this.generateTestGroupAccordingToPercentageAndConfigure(),this.persistABTestingSettingsToLS()))},IntentIqObject.prototype.initABTestingConfiguration=function(){switch(this.intentIqConfig.abTesting.configurationSource.currentConfigurationSource){case this.intentIqConfig.abTesting.configurationSource.group:this.configurationSourceGroupInitilization();break;case this.intentIqConfig.abTesting.configurationSource.percentage:this.configurationSourcePercentageInitilization();break;case this.intentIqConfig.abTesting.configurationSource.iiqserver:this.configureABTestingForIIQServer();break;case this.intentIqConfig.abTesting.configurationSource.disabled:this.configureABTestingForGroupA()}this.abTestingAdvancedConfiguration()},IntentIqObject.prototype.generateTestGroupAccordingToPercentageAndConfigure=function(){this.generateRandom1to99()<this.intentIqConfig.abTesting.currentPercentage?(this.intentIqConfig.abTesting.currentTestGroup=this.intentIqConfig.abTesting.groupNames.withIIQ,this.intentIqConfig.isInPassiveMode=!1):(this.intentIqConfig.abTesting.currentTestGroup=this.intentIqConfig.abTesting.groupNames.withoutIIQ,this.intentIqConfig.isInPassiveMode=!0)},IntentIqObject.prototype.persistABTestingSettingsToLS=function(){this.isDefined(this.intentIqConfig.abTesting.currentTestGroup)&&this.storeData(this.intentIqConfig.lsKeys.abGroup,this.intentIqConfig.abTesting.currentTestGroup),this.isDefined(this.intentIqConfig.abTesting.currentPercentage)&&this.storeData(this.intentIqConfig.lsKeys.abPercentage,this.intentIqConfig.abTesting.currentPercentage)},IntentIqObject.prototype.getRequest=function(t,e,n,i){var r=new XMLHttpRequest;this.intentIqConfig.isAsyncServerRequest?r.open("GET",t,!0):r.open("GET",t,!1),t.startsWith("https")&&(r.withCredentials=!0),r.timeout=e,r.onreadystatechange=function(){n&&4===r.readyState&&n(r.responseText)},r.ontimeout=function(){i&&i()},r.send()},IntentIqObject.prototype.makeServerRequest=function(t,e){var n=this,i=!1;this.logger.info("Sending request"),this.requestRtt=Date.now(),!0===e&&(this.logger.info("Setting prebid config callback timeout"),this.callbackTimeotID||(this.callbackTimeotID=setTimeout(this.fireCallbackOnRequestTimeout.bind(null,this),this.intentIqConfig.timeoutInMillis))),this.clearCounters(),this.getRequest(t,9999999,function(t){n.intentIqConfig.analytics.requestRtt=Date.now()-n.requestRtt;var e=n.tryParse(t);e&&(n.partnerData.date=Date.now(),"pid"in e&&(n.intentIqConfig.analytics.profile=e.pid,"ls"in e&&!0===e.ls&&(n.firstPartyData.pid=e.pid,i=!0)),"dbsaved"in e&&(n.firstPartyData.dbsaved=e.dbsaved,i=!0),"cttl"in e?(n.currentDataTTl=e.cttl,n.logger.info("Received custom TTL from server, value: "+n.currentDataTTl)):(n.currentDataTTl=n.intentIqConfig.refreshInMillis,n.logger.info("No custom TTL from server, setting customers value: "+n.currentDataTTl)),"gtwaddr"in e&&(n.gatewayServerAddress=e.gtwaddr),"tc"in e&&(n.intentIqConfig.analytics.terminationCause=e.tc,"mde"in e&&!0===e.mde&&!1===n.gatewayWasCalled&&!0===e.mde&&35===n.intentIqConfig.analytics.terminationCause&&"Safari"===n.detectBrowser()&&(n.logger.info("VP detected, trying to resolve."),n.gatewayWasCalled=!0,t=n.createRequestUrl(!0),n.makeServerRequest(t+="&gtw=true",!0))),"ct"in e&&(n.intentIqConfig.analytics.clientType=e.ct),"adt"in e&&(n.intentIqConfig.analytics.adserverDeviceType=e.adt),"sid"in e&&(n.intentIqConfig.analytics.siteId=e.sid),"pidd"in e&&(n.intentIqConfig.analytics.isProfileDeterministic=e.pidd),n.tryExtractConfiguration(e),n.containsEids(e)||(n.noDataCounter=n.noDataCounter+1),e.ls&&(!n.intentIqConfig.isInPassiveMode&&n.intentIqConfig.abTesting.currentTestGroup!==n.intentIqConfig.abTesting.groupNames.withoutIIQ||(e.data={}),n.partnerData.data=e.data,n.intentIqData=e.data,n.extractIdentittyModulesIds(),n.fillEidsNames(),n.eidsReceptionsTime=Date.now()),n.logger.info("Received Data: "+JSON.stringify(e))),i&&n.storeData(n.intentIqConfig.lsKeys.FIRST_PARTY_KEY,JSON.stringify(n.firstPartyData)),n.savePartnerDataToLocalStore(),n.isPrebidConfigurationSet||(n.isPrebidConfigurationSet=!0,n.configurePrebid()),n.fireCallback()},function(){n.intentIqConfig.analytics.requestRtt=-1,n.fireCallback()})},IntentIqObject.prototype.savePartnerDataToLocalStore=function(){this.partnerData||(this.partnerData=this.tryParse(this.readData(this.intentIqConfig.lsKeys.PARTNER_DATA_KEY))),this.partnerData&&(this.partnerData.callCount=this.callCount,this.partnerData.pubprovidedPrebidCallCount=this.pubprovidedPrebidCallCount,this.partnerData.manualCallCount=this.manualCallCount,this.partnerData.failCount=this.failCount,this.partnerData.noDataCounter=this.noDataCounter,this.partnerData.cttl=this.currentDataTTl,this.partnerData.clientType=this.intentIqConfig.analytics.clientType,this.partnerData.adserverDeviceType=this.intentIqConfig.analytics.adserverDeviceType,this.partnerData.terminationCause=this.intentIqConfig.analytics.terminationCause,this.partnerData.profile=this.intentIqConfig.analytics.profile,this.partnerData.pidDeterministic=this.intentIqConfig.analytics.pidDeterministic,this.partnerData.siteId=this.intentIqConfig.analytics.siteId,this.storeData(this.intentIqConfig.lsKeys.PARTNER_DATA_KEY,JSON.stringify(this.partnerData)))},IntentIqObject.prototype.createRequestUrl=function(t){t=(!0===t?this.gatewayServerAddress:this.intentIqConfig.iiqServerAddress)+"/profiles_engine/ProfilesEngineServlet?at=39&mi=10&dpi="+this.intentIqConfig.partner+"&pt=17&dpn=1";return t+=this.intentIqConfig.pai?"&pai="+encodeURIComponent(this.intentIqConfig.pai):"",t+=this.version?"&jsver="+encodeURIComponent(this.version):"",t=this.appendFirstPartyDataToUrl(t),t+=this.appendCallCount(t),t+="number"==typeof this.failCount?"&iiqfailcount="+encodeURIComponent(this.failCount):"",t+="number"==typeof this.noDataCounter?"&iiqnodata="+encodeURIComponent(0<this.noDataCounter):"",t+="&iiqlocalstorageenabled="+encodeURIComponent(this.hasLocalStorage()),t=this.addUniquenessToUrl(t),t=this.addMetaData(t),t+="&cttl="+encodeURIComponent(this.currentDataTTl),t=this.appendPartnersFirsyParty(t),t=this.appendRttDate(t),t=this.appendLastDataUpdateDate(t),t=this.appendWithAnalyticsData(t),t+="number"==typeof this.pubprovidedPrebidCallCount?"&iiqppcc="+encodeURIComponent(this.pubprovidedPrebidCallCount):"",t=this.appendReferrerToUrl(t)},IntentIqObject.prototype.appendCallCount=function(t){return null===this.intentIqConfig.pbjs?"number"==typeof this.manualCallCount?"&iiqcallcount="+encodeURIComponent(this.manualCallCount):"":"number"==typeof this.callCount?"&iiqcallcount="+encodeURIComponent(this.callCount):""},IntentIqObject.prototype.appendLastDataUpdateDate=function(t){return t=!isNaN(this.lastDataUpdateDate)?t+"&"+this.intentIqConfig.urlParamsNames.lastDataUpdateDate+"="+this.lastDataUpdateDate:t},IntentIqObject.prototype.appendRttDate=function(t){return t=!isNaN(this.intentIqConfig.analytics.requestRtt)?t+"&"+this.intentIqConfig.urlParamsNames.requestRtt+"="+this.intentIqConfig.analytics.requestRtt:t},IntentIqObject.prototype.appendWithAnalyticsData=function(t){return t=t+"&"+this.intentIqConfig.urlParamsNames.testGroup+"="+this.intentIqConfig.abTesting.currentTestGroup},IntentIqObject.prototype.appendABTestingData=function(t){try{this.isDefined(this.intentIqConfig.abTesting.isInTestGroup)&&(t=t+"&"+this.intentIqConfig.urlParamsNames.isInTestGroup+"="+this.intentIqConfig.abTesting.isInTestGroup),this.isDefined(this.intentIqConfig.abTesting.currentPercentage)&&(t=t+"&"+this.intentIqConfig.urlParamsNames.testPercentage+"="+this.intentIqConfig.abTesting.currentPercentage),this.isDefined(this.intentIqConfig.abTesting.currentTestGroup)&&(t=t+"&"+this.intentIqConfig.urlParamsNames.testGroup+"="+this.intentIqConfig.abTesting.currentTestGroup)}catch(t){this.logger.error(t)}return t},IntentIqObject.prototype.appendPartnersFirsyParty=function(t){try{if(-1===this.intentIqConfig.partnerClientIdType)return t;""!==this.intentIqConfig.partnerClientId&&(t=(t=t+"&pcid="+this.intentIqConfig.partnerClientId)+"&idtype="+this.intentIqConfig.partnerClientIdType)}catch(t){this.logger.error(t)}return t},IntentIqObject.prototype.addMetaData=function(t){return isNaN(this.intentIqConfig.sourceMetaData)?t:t+="&fbp="+this.intentIqConfig.sourceMetaData},IntentIqObject.prototype.addUniquenessToUrl=function(t){return t+="&tsrnd="+Math.floor(1e3*Math.random())+"_"+(new Date).getTime()},IntentIqObject.prototype.appendFirstPartyDataToUrl=function(t){return t+=this.isDebug()?"&ip="+encodeURIComponent(this.generateRandomUsIp()):"",t+=this.firstPartyData.pid?"&pid="+encodeURIComponent(this.firstPartyData.pid):"",t+=this.firstPartyData.dbsaved?"&dbsaved="+encodeURIComponent(this.firstPartyData.dbsaved):"",t+=this.firstPartyData.pcid?"&iiqidtype=2&iiqpcid="+encodeURIComponent(this.firstPartyData.pcid):"",t+=this.firstPartyData.pcidDate?"&iiqpciddate="+encodeURIComponent(this.firstPartyData.pcidDate):""},IntentIqObject.prototype.appendReferrerToUrl=function(t){return""!==this.getRefferer()&&(t+="&vrref="+this.getRefferer()),t},IntentIqObject.prototype.getRefferer=function(){return""!==this.intentIqConfig.domainName?encodeURIComponent(this.intentIqConfig.domainName):document.referrer&&""!==document.referrer?encodeURIComponent(document.referrer):""},IntentIqObject.prototype.updatePrebidObject=function(t,e){try{if(!t)return void this.logger.fatal("PBJS not provided while trying to update pbjs objecr refference");if(!e)return void this.logger.error("CALLBACK not provided while trying to update pbjs objecr refference");this.logger.info("String PBJS Reconfiguration"),this.intentIqConfig.subscriptionFlags={bidWon:!1,bidRequested:!1,beforeBidderHttp:!1,auctionInited:!1},this.wasCallbackFired=!1,this.intentIqConfig.pbjs=t,this.intentIqConfig.callback=e,this.subscribeForPrebidEvents(),this.configurePrebid(),this.getIntentIqData()}catch(t){this.logger.error(t)}},IntentIqObject.prototype.auctionCallCounter=function(t,e){e.logger.info("Auction started."),e.callCount++,e.savePartnerDataToLocalStore()},IntentIqObject.prototype.onBidWonEvent=function(t,e){try{if(!e.intentIqConfig.pbmonitoring.pbMonitoringEnabled)return void e.logger.info("pbMonitoringEnabled is disabled ");if(t==={})return void e.logger.info("eventData is empty");var n=e.prepareDataForDelivery(t,null,e);if(null===n)return void e.logger.info("Failed to prepare bid won data to send, "+e.intentIqConfig.partner);e.addDataToSendAndInitSender(n,e)}catch(t){e.logger.error(t)}},IntentIqObject.prototype.addDataToSendAndInitSender=function(t,e){try{e.messagesArray.push(t),e.logger.info("New data available to send, "+e.intentIqConfig.partner),e.startSender()}catch(t){e.logger.error(t)}},IntentIqObject.prototype.prepareDataForDelivery=function(t,e,n){try{if(-1!==n.intentIqConfig.pbmonitoring.pbPauseUntill&&!isNaN(n.intentIqConfig.pbmonitoring.pbPauseUntill)&&Date.now()<n.intentIqConfig.pbmonitoring.pbPauseUntill)return{};var i,r,o={};if(e)e&&(o.bidderCode=e.bidderCode,o.cpm=e.cpm,o.currency=e.currency,o.originalCpm=e.originalCpm,o.originalCurrency=e.originalCurrency,o.status=e.status,o.biddingPlatformId=e.biddingPlatformId,o.prebidAuctionId=e.prebidAuctionId,o.placementId=e.placementId,o.partnerAuctionId=e.partnerAuctionId,n.partnerAuctionIdsArray.push(o.partnerAuctionId));else{t.bidderCode&&(o.bidderCode=t.bidderCode),t.cpm&&(o.cpm=t.cpm),t.currency&&(o.currency=t.currency),t.originalCpm&&(o.originalCpm=t.originalCpm),t.originalCurrency&&(o.originalCurrency=t.originalCurrency),t.status&&(o.status=t.status),t.auctionId&&(o.prebidAuctionId=t.auctionId);var s=!1;if(t.params&&Array.isArray(t.params))for(var a=0;a<t.params.length;a++)if(t.params[0].placementId){o.placementId=t.params[0].placementId,s=!0;break}!1===s&&t.adUnitCode&&(o.placementId=t.adUnitCode),o.biddingPlatformId=1,o.partnerAuctionId="BW"}i=n.auctionStartTimeData[o.prebidAuctionId]||0,o[n.intentIqConfig.serverResponse.abPercentage]=n.intentIqConfig.abTesting.currentPercentage,o[n.intentIqConfig.serverResponse.abTestGroup]=n.intentIqConfig.abTesting.currentTestGroup,o[n.intentIqConfig.serverResponse.isInTestGroup]=n.intentIqConfig.abTesting.currentTestGroup,o[n.intentIqConfig.serverResponse.wasSubscribedForPrebid]=n.isSubscribedForPrebidEvents,o[n.intentIqConfig.serverResponse.enhanceRequests]=n.intentIqConfig.shouldSetUidsModulesConfig,o[n.intentIqConfig.serverResponse.hadEids]=!(null===n.eidsReceptionsTime||i<n.eidsReceptionsTime),void 0===n.auctionStartTimeData[o.prebidAuctionId]&&(o[n.intentIqConfig.serverResponse.hadEids]=void 0),o[n.intentIqConfig.serverResponse.userActualPercentage]=n.userProvidedConfig.abPercentage,o[n.intentIqConfig.serverResponse.ABTestingConfigurationSource]=n.userProvidedConfig.ABTestingConfigurationSource,o[n.intentIqConfig.serverResponse.jsverion]=n.version,o[n.intentIqConfig.serverResponse.lateConfiguration]=0===i?void 0:n.configurationTime>i,0!==i&&n.configurationTime>i&&n.logger.info("Late configuration suspected. Events were missed."),o[n.intentIqConfig.serverResponse.eidsNames]=n.eidsNames,o[n.intentIqConfig.serverResponse.requestRtt]=n.intentIqConfig.analytics.requestRtt,n.intentIqConfig.analytics.requestRtt=0,n.requestRtt=0,o[n.intentIqConfig.serverResponse.clientType]=n.intentIqConfig.analytics.clientType,o[n.intentIqConfig.serverResponse.adserverDeviceType]=n.intentIqConfig.analytics.adserverDeviceType,o[n.intentIqConfig.serverResponse.terminationCause]=n.intentIqConfig.analytics.terminationCause,o[n.intentIqConfig.serverResponse.profile]=n.intentIqConfig.analytics.profile,o[n.intentIqConfig.serverResponse.siteId]=n.intentIqConfig.analytics.siteId,o[n.intentIqConfig.serverResponse.hadEidsInLocalStorage]=n.hadEidsInLocalStorage,o[n.intentIqConfig.serverResponse.auctionStartTime]=i,o[n.intentIqConfig.serverResponse.eidsReadTime]=n.eidsReceptionsTime,o[n.intentIqConfig.serverResponse.agentId]=n.agentId,o[n.intentIqConfig.serverResponse.auctionEidsLegth]=n.auctionEidsLength[o.prebidAuctionId],o[n.intentIqConfig.serverResponse.wasServerCalled]=n.wasServerCalled,o[n.intentIqConfig.serverResponse.refferer]=n.getRefferer(),!n.hasLocalStorage()||null!==(r=n.readData(n.intentIqConfig.lsKeys.FIRST_PARTY_KEY))&&("pcid"in(r=JSON.parse(r))&&(r=r.pcid),o.pcid=r),o.partnerId=n.intentIqConfig.partner;var d=btoa(JSON.stringify(o));return n.logger.info("Data conversion succeed : "+JSON.stringify(d)),d}catch(t){return n.logger.error("Failed to convert data"),n.logger.error(t),{}}},IntentIqObject.prototype.startSender=function(){try{this.logger.info("We have some data to send - starting delayed sender. Delay = "+this.intentIqConfig.messageSendingDelay),this.isDefined(this.delayedSenderTimeouter)&&(this.logger.info("Updating sender"),clearTimeout(this.delayedSenderTimeouter)),this.delayedSenderTimeouter=setTimeout(this.dataSender.bind(null,this),this.intentIqConfig.messageSendingDelay)}catch(t){this.logger.error(t)}},IntentIqObject.prototype.dataSender=function(e){try{if(0==e.messagesArray.length)return void e.logger.info("Skipping data send , array is empty");var t="GET"===e.intentIqConfig.reportMethod,n=JSON.stringify(e.messagesArray),i=new XMLHttpRequest,r=e.reportingServerAddress+"/"+e.dataReportingPath+"?pid="+e.intentIqConfig.partner+"&mct="+e.messagesArray.length+"&agid="+e.agentId+(e.firstPartyData.pid?"&iiqid="+encodeURIComponent(e.firstPartyData.pcid):"")+"&jsver="+e.version+"&vrref="+e.getRefferer()+"&paucid="+encodeURIComponent(JSON.stringify(e.partnerAuctionIdsArray));t&&(r+="&payload="+n),r.startsWith("https")&&(i.withCredentials=!0),i.open(t?"GET":"POST",r,!0),t?i.setRequestHeader("Content-type","text/plain"):(i.setRequestHeader("Content-type","application/json"),i.setRequestHeader("Access-Control-Allow-Origin","*"),i.setRequestHeader("Access-Control-Allow-Credentials","true"),i.setRequestHeader("Access-Control-Allow-Methods","GET,HEAD,OPTIONS,POST,PUT"),i.setRequestHeader("Access-Control-Allow-Headers","Access-Control-Allow-Headers, Origin,Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers")),e.messagesArray=[],e.partnerAuctionIdsArray=[],i.onreadystatechange=function(){4==i.readyState&&200==i.status&&e.processResponse(i.responseText)},e.logger.info("Trying to send data: "),e.logger.info(n),t?i.send():i.send(n)}catch(t){e.logger.error(t)}},IntentIqObject.prototype.processResponse=function(t){try{if(this.logger.info("Response received"+JSON.stringify(t)),!this.isDefined(t))return void this.logger.info("Response is empty");var e=this.tryParse(t);if(!Array.isArray(e))return void this.logger.info("Wrong response format (not an array): "+t);if(0===e.length)return void this.logger.info("Control array is empty: "+t);this.logger.info("Sending new cntroll param for processing: "+JSON.stringify(e[0])),this.tryExtractConfiguration(e[0])}catch(t){this.logger.error(t)}},IntentIqObject.prototype.reportExternalWin=function(t){try{var e=new PartnersWinEvent(t),n=this.prepareDataForDelivery(null,e,this);if(null===n)return void this.logger.info("Failed to prepare bid won data to send, "+this.intentIqConfig.partner);this.addDataToSendAndInitSender(n,this)}catch(t){this.logger.error(t)}},IntentIqObject.prototype.tryRegisterForBidRequested=function(e){e.intentIqConfig.pbjs.onEvent("bidRequested",function(t){e.clearDuplictesBeforeRubicon(t,e)})},IntentIqObject.prototype.clearDuplictesBeforeRubicon=function(t,e){try{if("rubicon"!==t.bidderCode||t.bids.length<1)return;if(null!=e.intentIqConfig.moduleIds.unifiedeId){var n,i=_createForOfIteratorHelper(t.bids);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.userId.tdid&&Array.isArray(r.userId.pubProvidedId)){for(var o=0;o<r.userId.pubProvidedId.length;o++)if("adserver.org"===r.userId.pubProvidedId[o].source){r.userId.pubProvidedId.splice(o,1);break}if(Array.isArray(r.userIdAsEids))for(var s=0;s<r.userIdAsEids.length;s++)if("adserver.org"===r.userIdAsEids[s].source&&r.userIdAsEids[s].uids[0].id===e.intentIqConfig.moduleIds.unifiedeId){r.userIdAsEids.splice(s,1);break}}}}catch(t){i.e(t)}finally{i.f()}}}catch(t){}},IntentIqObject.prototype.configurePrebid=function(){try{this.logger.info("Starting Prebid configuration "),this.intentIqConfig.pbjs&&this.intentIqConfig.pbjs.que?(this.logger.info("Pushing config for prebid "),this.intentIqConfig.pbjs.que.push(this.tryRegisterIds.bind(null,this))):this.logger.info("PBJS or QUE not defined")}catch(t){this.logger.error(t)}},IntentIqObject.prototype.subscribeForPrebidEvents=function(){try{this.logger.info("Starting Prebid subscription "),this.intentIqConfig.pbjs&&this.intentIqConfig.pbjs.que?(this.intentIqConfig.shouldClearDuplicatresForRubicon&&!this.intentIqConfig.subscriptionFlags.bidRequested&&(this.logger.info("Subscribing for bidRequested for rubicon cleanup"),this.intentIqConfig.pbjs.que.push(this.tryRegisterForBidRequested.bind(null,this)),this.intentIqConfig.subscriptionFlags.bidRequested=!0),this.intentIqConfig.pbmonitoring.pbMonitoringEnabled&&!this.intentIqConfig.subscriptionFlags.bidWon?(this.logger.info("Registering for subscription for bidWon event"),this.intentIqConfig.pbjs.que.push(this.tryRegisterForBidWon.bind(null,this)),this.intentIqConfig.subscriptionFlags.bidWon=!0):!0===this.intentIqConfig.manualWinReportEnabled&&this.logger.info("Manual won report enabled. Skipping bidwon subscription."),this.intentIqConfig.subscriptionFlags.auctionInited||(this.logger.info("Subscribing for auctionInited event"),this.intentIqConfig.pbjs.que.push(this.tryRegisterForAuctionInited.bind(null,this)),this.intentIqConfig.subscriptionFlags.auctionInited=!0)):this.logger.info("PBJS or QUE not defined")}catch(t){this.logger.error(t)}},IntentIqObject.prototype.tryRegisterForAuctionInited=function(e){e.intentIqConfig.pbjs.onEvent("auctionInit",function(t){try{e.auctionEidsLength[t.auctionId]=t.bidderRequests[0].bids[0].userId&&t.bidderRequests[0].bids[0].userId.pubProvidedId?t.bidderRequests[0].bids[0].userId.pubProvidedId.length:-1}catch(t){}try{e.auctionStartTimeData[t.auctionId]=t.timestamp,e.auctionCallCounter(t,e)}catch(t){}})},IntentIqObject.prototype.tryRegisterForBidWon=function(e){e.intentIqConfig.pbjs.onEvent("bidWon",function(t){e.onBidWonEvent(t,e)})},IntentIqObject.prototype.tryRegisterIds=function(e){if(void 0!==e)try{var t={name:"pubProvidedId",params:{eidsFunction:e.getPubprovidedEids.bind(null,e)}},n=e.intentIqConfig.pbjs.getConfig("userSync.userIds");if(e.logger.info("Registering PubProvided callback "),n?e.intentIqConfig.shouldRepalcePubprovided?(e.logger.info("Configured to set before others pubprovided"),n.unshift(t),e.intentIqConfig.pbjs.setConfig({userSync:{userIds:n}})):n.push(t):e.intentIqConfig.pbjs.setConfig({userSync:{userIds:[t]}}),!e.intentIqConfig.shouldSetUidsModulesConfig||null===e.intentIqConfig.moduleIds.unifiedeId)return void e.intentIqConfig.pbjs.refreshUserIds();t=e.setConfigObjectForUnifiedId(e.intentIqConfig.moduleIds.unifiedeId),(n=e.intentIqConfig.pbjs.getConfig("userSync.userIds"))&&Array.isArray(n)?(0!==n.filter(function(t){return"unifiedId"===t.name}).length&&!e.intentIqConfig.shouldReplaceUnifiedId||(e.logger.info("Unshifting configuration for unifyedIds"),n.unshift(t)),e.intentIqConfig.pbjs.setConfig({userSync:{userIds:n}})):e.intentIqConfig.pbjs.setConfig({userSync:{userIds:[t]}}),e.intentIqConfig.pbjs.refreshUserIds()}catch(t){e.logger.error("Faild to register EIDS")}else console.log("IIQ : tryRegisterIds iiq object is undefined")},IntentIqObject.prototype.setConfigObjectForUnifiedId=function(t){return{name:"unifiedId",value:{tdid:t}}};
